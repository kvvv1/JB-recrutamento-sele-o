{% extends "base.html" %}

{% block title %}Indicadores{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-12">
            <h1 class="text-center mb-4">Indicadores de Desempenho</h1>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-4">
            <label for="sectorSelect" class="form-label">Selecione o Setor:</label>
            <select id="sectorSelect" class="form-select">
                <option value="">Todos os Setores</option>
                <option value="RH">RH</option>
                <option value="Suprimentos">Suprimentos</option>
                <option value="DP">DP</option>
                <option value="Operacional">Operacional</option>
            </select>
        </div>
        <div class="col-md-8 text-center">
            <div class="row">
                <div class="col-md-6">
                    <div class="card text-white bg-primary mb-3">
                        <div class="card-body">
                            <h5 class="card-title">Senhas Emitidas Hoje</h5>
                            <p class="card-text">{{ total_tickets }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card text-white bg-success mb-3">
                        <div class="card-body">
                            <h5 class="card-title">Senhas Concluídas Hoje</h5>
                            <p class="card-text">{{ total_concluido }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title text-center">Senhas por Categoria</h4>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="ticketsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title text-center">Tempo Médio de Espera por Categoria (minutos)</h4>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="waitTimeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title text-center">Tempo Médio de Atendimento por Categoria (minutos)</h4>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="serviceTimeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title text-center">Tempo de Espera vs. Tempo de Atendimento</h4>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="timeComparisonChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title text-center">Comparação de Tickets Emitidos e Concluídos por Semana/Mês</h4>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row history-section">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title text-center">Histórico de Chamadas</h4>
                </div>
                <div class="card-body history-table">
                    <table class="table table-striped">
                        <thead class="thead-dark">
                            <tr>
                                <th>Senha</th>
                                <th>Nome</th>
                                <th>Categoria</th>
                                <th>Criado em</th>
                                <th>Chamado em</th>
                                <th>Concluído em</th>
                                <th>Tempo de Espera</th>
                                <th>Tempo de Atendimento</th>
                                <th>Tempo Total no RH</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ticket in historical_data %}
                            <tr>
                                <td>{{ ticket.ticket_number }}</td>
                                <td>{{ ticket.name }}</td>
                                <td>{{ ticket.category }}</td>
                                <td>{{ ticket.created_at }}</td>
                                <td>{{ ticket.called_at }}</td>
                                <td>{{ ticket.concluded_at }}</td>
                                <td>{{ ticket.wait_time }}</td>
                                <td>{{ ticket.service_time }}</td>
                                <td>{{ ticket.total_time }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var counts = JSON.parse('{{ counts | tojson | safe }}');
        var averageWaitTimes = JSON.parse('{{ average_wait_times | tojson | safe }}');
        var averageServiceTimes = JSON.parse('{{ average_service_times | tojson | safe }}');
        var ticketsIssued = JSON.parse('{{ tickets_issued | tojson | safe }}');
        var ticketsCompleted = JSON.parse('{{ tickets_completed | tojson | safe }}');

        updateCharts(counts, averageWaitTimes, averageServiceTimes, ticketsIssued, ticketsCompleted);
    });

    function updateCharts(counts, averageWaitTimes, averageServiceTimes, ticketsIssued, ticketsCompleted) {
        var ctxTickets = document.getElementById('ticketsChart').getContext('2d');
        var ticketsChart = new Chart(ctxTickets, {
            type: 'bar',
            data: {
                labels: Object.keys(counts),
                datasets: [{
                    label: 'Senhas Emitidas',
                    data: Object.values(counts),
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        var ctxWaitTime = document.getElementById('waitTimeChart').getContext('2d');
        var waitTimeChart = new Chart(ctxWaitTime, {
            type: 'bar',
            data: {
                labels: Object.keys(averageWaitTimes),
                datasets: [{
                    label: 'Tempo Médio de Espera (min)',
                    data: Object.values(averageWaitTimes),
                    backgroundColor: 'rgba(255, 206, 86, 0.2)',
                    borderColor: 'rgba(255, 206, 86, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        var ctxServiceTime = document.getElementById('serviceTimeChart').getContext('2d');
        var serviceTimeChart = new Chart(ctxServiceTime, {
            type: 'bar',
            data: {
                labels: Object.keys(averageServiceTimes),
                datasets: [{
                    label: 'Tempo Médio de Atendimento (min)',
                    data: Object.values(averageServiceTimes),
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        var ctxComparison = document.getElementById('comparisonChart').getContext('2d');
        var comparisonChart = new Chart(ctxComparison, {
            type: 'line',
            data: {
                labels: Object.keys(counts),
                datasets: [
                    {
                        label: 'Tickets Emitidos',
                        data: ticketsIssued,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Tickets Concluídos',
                        data: ticketsCompleted,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        var ctxTimeComparison = document.getElementById('timeComparisonChart').getContext('2d');
        var timeComparisonChart = new Chart(ctxTimeComparison, {
            type: 'line',
            data: {
                labels: Object.keys(averageWaitTimes),
                datasets: [
                    {
                        label: 'Tempo de Espera Médio (min)',
                        data: Object.values(averageWaitTimes),
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Tempo de Atendimento Médio (min)',
                        data: Object.values(averageServiceTimes),
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    document.getElementById('sectorSelect').addEventListener('change', function() {
        const sector = this.value;
        // Adicione a lógica para buscar e atualizar os gráficos com base no setor selecionado
    });
</script>
{% endblock %}
